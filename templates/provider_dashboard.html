<!DOCTYPE html>
<html>
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Provider Dashboard</title>
  <link rel="stylesheet" href="/static/style.css" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { height: 280px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); }
    .muted { opacity: 0.75; font-size: 14px; }

    .badge { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.2); font-size: 12px; }
    .ok { border-color: rgba(80,255,160,0.45); }
    .no { border-color: rgba(255,77,77,0.45); }
    .warn { border-color: rgba(255,200,80,0.45); }

    .item { margin-top: 12px; padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.04); }
    .top { display:flex; justify-content: space-between; gap:10px; align-items:flex-start; }
    .actions { margin-top: 10px; display:flex; gap:10px; flex-wrap: wrap; }

    .sectionHeader { margin-top: 14px; font-weight: 800; }
    .smallBtn { padding: 8px 10px; border-radius: 10px; background: rgba(255,255,255,0.08); color: #e9eef7; cursor:pointer; border:none; }
    .smallBtn:hover { background: rgba(255,255,255,0.12); }

    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12); font-size: 12px; }
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <h1>Provider Dashboard</h1>
      <a class="btn secondary" href="/logout">Logout</a>
    </div>

    <p>Welcome, <b>{{ user.name }}</b> ({{ user.email }})</p>

    <!-- Service Area Setup -->
    <div class="card">
      <h2>Your Service Area</h2>
      <p class="muted">Click map to set your base pin. Choose radius (km). Then Save.</p>

      <form method="POST" action="/provider/service" id="serviceForm">
        <input type="hidden" name="lat" id="lat" value="{{ user.lat or '' }}">
        <input type="hidden" name="lng" id="lng" value="{{ user.lng or '' }}">

        <label>
          Radius (km)
          <input name="service_radius_km" id="radius" type="number" step="0.5" min="0"
                 value="{{ user.service_radius_km or 5 }}" />
        </label>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button type="button" class="btn" id="useCurrentBtn">Use current location</button>
          <button class="btn primary" type="submit">Save service area</button>
        </div>

        <div class="muted" id="status" style="margin-top:8px;"></div>
      </form>

      <div style="margin-top:12px;">
        <div id="map"></div>
      </div>
    </div>

    <!-- Requests Feed -->
    <div class="card">
      <div class="row">
        <h2>Requests In Your Service Area</h2>
        <button class="btn" id="refreshBtn" type="button">Refresh</button>
      </div>

      <div class="muted" id="summary" style="margin-top:6px;"></div>

      <div id="list" class="muted" style="margin-top:10px;">Loading‚Ä¶</div>

      <div class="sectionHeader">Serviced (history)</div>
      <div id="servicedList" class="muted" style="margin-top:10px;">‚Äî</div>
    </div>
  </div>

<script>
  // ---------- Map ----------
  const defaultLat = -31.9523, defaultLng = 115.8613;

  const latInput = document.getElementById("lat");
  const lngInput = document.getElementById("lng");
  const statusEl = document.getElementById("status");

  const savedLat = parseFloat(latInput.value);
  const savedLng = parseFloat(lngInput.value);

  const startLat = Number.isFinite(savedLat) ? savedLat : defaultLat;
  const startLng = Number.isFinite(savedLng) ? savedLng : defaultLng;

  const map = L.map("map").setView([startLat, startLng], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  let marker = null;

  function setMarker(lat, lng, zoomTo=false) {
    latInput.value = lat;
    lngInput.value = lng;

    if (!marker) {
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on("dragend", () => {
        const p = marker.getLatLng();
        latInput.value = p.lat.toFixed(6);
        lngInput.value = p.lng.toFixed(6);
        statusEl.textContent = "Pin updated. Save to apply.";
      });
    } else {
      marker.setLatLng([lat, lng]);
    }
    if (zoomTo) map.setView([lat, lng], 15);
    statusEl.textContent = "Pin set. Save to apply.";
  }

  if (Number.isFinite(savedLat) && Number.isFinite(savedLng)) {
    setMarker(savedLat, savedLng, false);
  }

  map.on("click", (e) => setMarker(e.latlng.lat, e.latlng.lng, false));

  document.getElementById("useCurrentBtn").addEventListener("click", () => {
    statusEl.textContent = "Requesting location permission‚Ä¶";
    if (!navigator.geolocation) return statusEl.textContent = "Geolocation not supported.";
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        setMarker(pos.coords.latitude, pos.coords.longitude, true);
        statusEl.textContent = "Current location captured. Save to apply.";
      },
      () => statusEl.textContent = "Could not get location (permission denied/unavailable).",
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

  // ---------- Requests ----------
  const list = document.getElementById("list");
  const servicedList = document.getElementById("servicedList");
  const refreshBtn = document.getElementById("refreshBtn");
  const summary = document.getElementById("summary");

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function isServiced(status){
    return String(status ?? "").toLowerCase() === "serviced";
  }

  function isOpen(status){
    return String(status ?? "").toLowerCase() === "open";
  }

  function badge(item){
    if (isServiced(item.status)) return `<span class="badge ok">‚úÖ Serviced</span>`;
    if (item.can_serve === true) return `<span class="badge ok">‚úÖ In range ‚Ä¢ ${item.distance_km} km</span>`;
    if (item.serve_reason && item.serve_reason.includes("Set your")) return `<span class="badge warn">‚ö†Ô∏è ${esc(item.serve_reason)}</span>`;
    if (item.serve_reason && item.serve_reason.includes("No pin")) return `<span class="badge warn">‚ö†Ô∏è ${esc(item.serve_reason)}</span>`;
    return `<span class="badge no">‚ùå ${esc(item.serve_reason || "Out of range")}</span>`;
  }

  function scheduleLine(r){
    const parts = [];
    if (r.scheduled_date) parts.push(`üìÖ ${esc(r.scheduled_date)}`);
    if (r.scheduled_time) parts.push(`‚è∞ ${esc(r.scheduled_time)}`);
    if (r.duration_min) parts.push(`‚è≥ ${esc(r.duration_min)} min`);
    if (r.hourly_wage != null) parts.push(`üí∞ ‚Çπ${esc(r.hourly_wage)}/hr`);
    if (!parts.length) return "";
    return `<div class="muted" style="margin-top:6px;">${parts.join(" ‚Ä¢ ")}</div>`;
  }

  async function markServiced(id, btn){
    btn.disabled = true;
    btn.textContent = "Marking‚Ä¶";

    try {
      const res = await fetch(`/api/requests/${id}/resolve`, { method: "POST", credentials: "same-origin" });
      const out = await res.json().catch(() => ({}));

      if (!res.ok) {
        alert(out.error || `Failed (${res.status})`);
        btn.disabled = false;
        btn.textContent = "Mark Serviced";
        return;
      }

      // If backend returns already=true
      if (out.already) {
        btn.textContent = "Already serviced ‚úÖ";
      } else {
        btn.textContent = "Serviced ‚úÖ";
      }

      await load();
    } catch (e) {
      alert("Network error.");
      btn.disabled = false;
      btn.textContent = "Mark Serviced";
    }
  }

  function renderInRangeOpen(r){
    const canServe = r.can_serve === true;
    const open = isOpen(r.status);
    const showAction = canServe && open;

    return `
      <div class="item">
        <div class="top">
          <div>
            <div style="font-weight:700;">
              ${esc(r.title)} <span class="muted">(${esc(r.category)})</span>
            </div>
            <div class="muted">From: ${esc(r.receiver_name)} ‚Ä¢ ${new Date(r.created_at).toLocaleString()}</div>
            <div class="muted">Location: ${esc(r.location_text || "‚Äî")}</div>
            ${scheduleLine(r)}
          </div>
          ${badge(r)}
        </div>

        ${r.details ? `<div class="muted" style="margin-top:8px;">${esc(r.details)}</div>` : ""}

        <div class="actions">
          ${showAction ? `<button class="smallBtn" data-service="${r.id}">Mark Serviced</button>` : `<span class="pill">No action</span>`}
        </div>
      </div>
    `;
  }

  function renderServiced(r){
    return `
      <div class="item">
        <div class="top">
          <div>
            <div style="font-weight:700;">
              ${esc(r.title)} <span class="muted">(${esc(r.category)})</span>
            </div>
            <div class="muted">From: ${esc(r.receiver_name)} ‚Ä¢ ${new Date(r.created_at).toLocaleString()}</div>
            ${scheduleLine(r)}
          </div>
          <span class="badge ok">‚úÖ Serviced</span>
        </div>
      </div>
    `;
  }

  function wireServiceButtons(){
    document.querySelectorAll("[data-service]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-service");
        markServiced(id, btn);
      });
    });
  }

  async function load() {
    list.textContent = "Loading‚Ä¶";
    servicedList.textContent = "Loading‚Ä¶";
    summary.textContent = "";

    const res = await fetch("/api/provider/requests", { credentials: "same-origin" });
    const data = await res.json().catch(() => null);

    if (!res.ok) {
      list.innerHTML = `<div class="muted">${esc((data && data.error) ? data.error : `Failed (${res.status})`)}</div>`;
      servicedList.innerHTML = "‚Äî";
      return;
    }

    if (!Array.isArray(data)) {
      list.innerHTML = `<div class="muted">Unexpected response.</div>`;
      servicedList.innerHTML = "‚Äî";
      return;
    }

    // ‚úÖ ONLY requests the provider can serve + open
    const inRangeOpen = data.filter(r => r.can_serve === true && isOpen(r.status));
    const serviced = data.filter(r => isServiced(r.status));

    summary.textContent =
      `Showing ${inRangeOpen.length} open request(s) inside your service radius.`;

    if (inRangeOpen.length === 0) {
      list.innerHTML = `<div class="muted">No open requests inside your service area right now.</div>`;
    } else {
      list.innerHTML = inRangeOpen.map(renderInRangeOpen).join("");
      wireServiceButtons();
    }

    if (serviced.length === 0) {
      servicedList.innerHTML = `<div class="muted">No serviced requests yet.</div>`;
    } else {
      servicedList.innerHTML = serviced.map(renderServiced).join("");
    }
  }

  refreshBtn.addEventListener("click", load);
  load();
</script>
</body>
</html>