<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receiver Dashboard</title>
  <link rel="stylesheet" href="/static/style.css" />

  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { height: 320px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); }
    .muted { opacity: 0.75; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <h1>Receiver Dashboard</h1>
      <a class="btn secondary" href="/logout">Logout</a>
    </div>

    <p>Welcome, <b>{{ user.name }}</b> ({{ user.email }})</p>

    <!-- ✅ Location card (give it an id so we can hide it) -->
    <div class="card" id="locationCard">
      <h2>Your Location</h2>
      <p class="muted">
        Add a safe location description + optionally pin on the map.
        “Use current location” will ask permission.
      </p>

      <form method="POST" action="/receiver/location" id="locForm">
        <label>
          Location details (text)
          <input name="location_text" id="location_text"
                 placeholder="Example: Near Curtin Uni library entrance"
                 value="{{ user.location_text or '' }}">
        </label>

        <input type="hidden" name="lat" id="lat" value="{{ user.lat or '' }}">
        <input type="hidden" name="lng" id="lng" value="{{ user.lng or '' }}">

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button type="button" class="btn" id="useCurrentBtn">Use current location</button>
          <button type="button" class="btn" id="clearPinBtn">Clear pin</button>
          <button type="button" class="btn primary" id="saveBtn">Save location</button>
        </div>

        <div class="muted" id="locStatus" style="margin-top:8px;"></div>
      </form>

      <div style="margin-top:12px;">
        <div id="map"></div>
        <div class="muted" style="margin-top:8px;">
          Tip: Click the map to drop a pin. Drag the pin to adjust.
        </div>
      </div>
    </div>

    <!-- ✅ Availability screen (hidden until after Save) -->
    <div class="card" id="availabilityCard" style="display:none;">
      <h2>Service Availability</h2>
      <p class="muted" id="availabilityReason"></p>

      <div id="availabilityDetails" class="muted" style="white-space:pre-line; margin-top:10px;"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;">
        <button type="button" class="btn" id="editLocationBtn">Edit location</button>
        <button type="button" class="btn primary" id="continueBtn">Continue to request</button>
      </div>
    </div>

    <!-- ✅ Request card (give id so we can scroll here) -->
    <div class="card" id="requestCard" style="display:none;">
      <h2>Create Request (next)</h2>
      <p class="muted">Next we’ll use your saved location automatically when you create a help request.</p>
    </div>

    <p><a href="/">Home</a></p>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Elements for screen switching
  const locationCard = document.getElementById("locationCard");
  const availabilityCard = document.getElementById("availabilityCard");
  const availabilityReason = document.getElementById("availabilityReason");
  const availabilityDetails = document.getElementById("availabilityDetails");
  const editLocationBtn = document.getElementById("editLocationBtn");
  const continueBtn = document.getElementById("continueBtn");
  const requestCard = document.getElementById("requestCard");

  // Default center
  const defaultLat = -31.9523;
  const defaultLng = 115.8613;

  const latInput = document.getElementById("lat");
  const lngInput = document.getElementById("lng");
  const locStatus = document.getElementById("locStatus");

  const savedLat = parseFloat(latInput.value);
  const savedLng = parseFloat(lngInput.value);

  const startLat = Number.isFinite(savedLat) ? savedLat : defaultLat;
  const startLng = Number.isFinite(savedLng) ? savedLng : defaultLng;

  // --- Map init ---
  const map = L.map('map').setView([startLat, startLng], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Fix occasional blank map rendering
  setTimeout(() => map.invalidateSize(), 150);

  let marker = null;

  function setMarker(lat, lng, zoomTo=true) {
    latInput.value = lat;
    lngInput.value = lng;

    if (!marker) {
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', () => {
        const pos = marker.getLatLng();
        latInput.value = pos.lat.toFixed(6);
        lngInput.value = pos.lng.toFixed(6);
        locStatus.textContent = `Pin updated: ${latInput.value}, ${lngInput.value}`;
      });
    } else {
      marker.setLatLng([lat, lng]);
    }

    if (zoomTo) map.setView([lat, lng], 16);
    locStatus.textContent = `Pin set: ${Number(lat).toFixed(6)}, ${Number(lng).toFixed(6)}`;
  }

  // If already saved, show marker
  if (Number.isFinite(savedLat) && Number.isFinite(savedLng)) {
    setMarker(savedLat, savedLng, false);
  }

  // Click map to place marker
  map.on('click', (e) => {
    setMarker(e.latlng.lat, e.latlng.lng, false);
  });

  // Use current location (browser GPS)
  document.getElementById("useCurrentBtn").addEventListener("click", () => {
    locStatus.textContent = "Requesting location permission…";
    if (!navigator.geolocation) {
      locStatus.textContent = "Geolocation not supported by your browser.";
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        setMarker(pos.coords.latitude, pos.coords.longitude, true);
        locStatus.textContent = "Current location captured. Save to store it.";
      },
      () => {
        locStatus.textContent = "Could not get location (permission denied or unavailable).";
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });

  // Clear pin
  document.getElementById("clearPinBtn").addEventListener("click", () => {
    latInput.value = "";
    lngInput.value = "";
    locStatus.textContent = "Pin cleared. Save to remove stored pin.";
    if (marker) {
      map.removeLayer(marker);
      marker = null;
    }
  });

  // Back to map (edit location)
  editLocationBtn.addEventListener("click", () => {
    availabilityCard.style.display = "none";
    locationCard.style.display = "block";
    setTimeout(() => map.invalidateSize(), 150);
  });

  // Continue to request section
  continueBtn.addEventListener("click", () => {
    requestCard.scrollIntoView({ behavior: "smooth", block: "start" });
  });

  // Save location + check service (no modal overlay now)
  document.getElementById("saveBtn").addEventListener("click", async () => {
    locStatus.textContent = "Saving…";

    const payload = {
      location_text: document.getElementById("location_text").value.trim(),
      lat: latInput.value ? parseFloat(latInput.value) : null,
      lng: lngInput.value ? parseFloat(lngInput.value) : null
    };

    try {
      const res = await fetch("/api/receiver/location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const out = await res.json().catch(() => ({}));

      if (!res.ok || !out.ok) {
        locStatus.textContent = "Save failed.";
        alert(out.error || "Could not save location.");
        return;
      }

      locStatus.textContent = "Saved ✅";

      // Build details text
      let details = `In range: ${out.providers_in_range ?? 0}`;

      if (out.providers_list && out.providers_list.length) {
        details += "\n\nNearest providers:\n" +
          out.providers_list
            .map(p => `${p.name} • ${p.distance_km} km (radius ${p.radius_km} km)`)
            .join("\n");
      } else {
        details += `\nConfigured providers: ${out.providers_configured ?? "?"} / Total: ${out.providers_total ?? "?"}`;
        if (out.nearest_provider_km != null) details += `\nNearest provider: ${out.nearest_provider_km} km`;
      }

      // Show availability "new interface"
      availabilityReason.textContent = out.reason || (out.can_serve ? "Service is available." : "Service is not available.");
      availabilityDetails.textContent = details;

      // Switch view: hide map card, show availability card
      locationCard.style.display = "none";
      availabilityCard.style.display = "block";

    } catch (e) {
      locStatus.textContent = "Network error.";
      alert("Network error while saving location.");
    }
  });
});
</script>

</body>
</html>